Run appleboy/ssh-action@v1.0.3
  with:
    envs: MYSQL_ROOT_PASSWORD,MYSQL_PASSWORD,CALCULATOR_DATABASE_URL,OPENAI_API_KEY,ANTHROPIC_API_KEY
    script: # --- This script runs directly on your DigitalOcean server ---
  
  echo "âœ… Connected to server. Starting deployment..."
  
  # Navigate to the project directory
  PROJECT_DIR="/opt/aequitas"
  mkdir -p $PROJECT_DIR
  cd $PROJECT_DIR
  
  echo "ðŸ”„ Cloning or updating main repository..."
  
  # Clone or update the main REPAR repository
  if [ ! -d "REPAR" ]; then
    git clone https://github.com/CreoDAMO/REPAR.git REPAR
  else
    cd REPAR && git pull && cd ..
  fi
  
  cd REPAR
  
  echo "ðŸ“ Creating .env file with secrets..."
  
  # Create .env file with secrets from GitHub Actions
  cat > .env << EOF
  MYSQL_ROOT_PASSWORD=
  MYSQL_PASSWORD=
  CALCULATOR_DATABASE_URL=
  OPENAI_API_KEY=***
  ANTHROPIC_API_KEY=***
  EOF
  
  # Secure the .env file
  chmod 600 .env
  
  echo "ðŸš€ Deploying services with Docker Compose..."
  
  # Stop existing containers
  docker-compose down
  
  # Build and start all services
  docker-compose up --build -d
  
  # Wait for services to stabilize
  sleep 10
  
  echo "ðŸ§¹ Pruning old Docker images to save space..."
  docker image prune -f
  
  echo "âœ… Verifying all containers are running..."
  docker ps
  
  echo "ðŸŽ‰ Deployment complete. All services are updated and running."
  
  echo "ðŸ“Š Container Status:"
  docker-compose ps
  
  echo "ðŸ”’ Security: .env file has been secured with 600 permissions"
  
  echo "ðŸ¥ Health Checks:"
  echo "Testing backend health..."
  curl -f http://localhost:3000/health || echo "Backend health check failed"
  echo ""
  echo "Testing calculator health..."
  curl -f http://localhost:3001/health || echo "Calculator health check may not be available"
  
    port: 22
    timeout: 30s
    command_timeout: 10m
    proxy_port: 22
    proxy_timeout: 30s
/usr/bin/docker run --name ec85a418021050084bf09d11438a85c55251_8ed0fd --label 53ec85 --workdir /github/workspace --rm -e "INPUT_HOST" -e "INPUT_USERNAME" -e "INPUT_KEY" -e "INPUT_ENVS" -e "INPUT_SCRIPT" -e "INPUT_PORT" -e "INPUT_PASSPHRASE" -e "INPUT_PASSWORD" -e "INPUT_SYNC" -e "INPUT_USE_INSECURE_CIPHER" -e "INPUT_CIPHER" -e "INPUT_TIMEOUT" -e "INPUT_COMMAND_TIMEOUT" -e "INPUT_KEY_PATH" -e "INPUT_FINGERPRINT" -e "INPUT_PROXY_HOST" -e "INPUT_PROXY_PORT" -e "INPUT_PROXY_USERNAME" -e "INPUT_PROXY_PASSWORD" -e "INPUT_PROXY_PASSPHRASE" -e "INPUT_PROXY_TIMEOUT" -e "INPUT_PROXY_KEY" -e "INPUT_PROXY_KEY_PATH" -e "INPUT_PROXY_FINGERPRINT" -e "INPUT_PROXY_CIPHER" -e "INPUT_PROXY_USE_INSECURE_CIPHER" -e "INPUT_SCRIPT_STOP" -e "INPUT_ENVS_FORMAT" -e "INPUT_DEBUG" -e "INPUT_ALLENVS" -e "INPUT_REQUEST_PTY" -e "HOME" -e "GITHUB_JOB" -e "GITHUB_REF" -e "GITHUB_SHA" -e "GITHUB_REPOSITORY" -e "GITHUB_REPOSITORY_OWNER" -e "GITHUB_REPOSITORY_OWNER_ID" -e "GITHUB_RUN_ID" -e "GITHUB_RUN_NUMBER" -e "GITHUB_RETENTION_DAYS" -e "GITHUB_RUN_ATTEMPT" -e "GITHUB_ACTOR_ID" -e "GITHUB_ACTOR" -e "GITHUB_WORKFLOW" -e "GITHUB_HEAD_REF" -e "GITHUB_BASE_REF" -e "GITHUB_EVENT_NAME" -e "GITHUB_SERVER_URL" -e "GITHUB_API_URL" -e "GITHUB_GRAPHQL_URL" -e "GITHUB_REF_NAME" -e "GITHUB_REF_PROTECTED" -e "GITHUB_REF_TYPE" -e "GITHUB_WORKFLOW_REF" -e "GITHUB_WORKFLOW_SHA" -e "GITHUB_REPOSITORY_ID" -e "GITHUB_TRIGGERING_ACTOR" -e "GITHUB_WORKSPACE" -e "GITHUB_ACTION" -e "GITHUB_EVENT_PATH" -e "GITHUB_ACTION_REPOSITORY" -e "GITHUB_ACTION_REF" -e "GITHUB_PATH" -e "GITHUB_ENV" -e "GITHUB_STEP_SUMMARY" -e "GITHUB_STATE" -e "GITHUB_OUTPUT" -e "RUNNER_OS" -e "RUNNER_ARCH" -e "RUNNER_NAME" -e "RUNNER_ENVIRONMENT" -e "RUNNER_TOOL_CACHE" -e "RUNNER_TEMP" -e "RUNNER_WORKSPACE" -e "ACTIONS_RUNTIME_URL" -e "ACTIONS_RUNTIME_TOKEN" -e "ACTIONS_CACHE_URL" -e "ACTIONS_RESULTS_URL" -e GITHUB_ACTIONS=true -e CI=true -v "/var/run/docker.sock":"/var/run/docker.sock" -v "/home/runner/work/_temp/_github_home":"/github/home" -v "/home/runner/work/_temp/_github_workflow":"/github/workflow" -v "/home/runner/work/_temp/_runner_file_commands":"/github/file_commands" -v "/home/runner/work/REPAR/REPAR":"/github/workspace" 53ec85:a418021050084bf09d11438a85c55251
2025/10/23 16:37:26 Error: missing server host